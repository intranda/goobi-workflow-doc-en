# 9.2. Update steps

The individual update steps that must be carried out to update a Goobi workflow installation to the required version are explained below. Please note that before carrying out the work documented here, you must first make a backup and, if necessary, carry out further preparatory work. These are documented here:

{% page-ref page="9.1.md" %}

## SNAPSHOT 22.06

### 2022-06-29
In the Apache httpd config there may still be obsolete options that prevent websockets from working. Delete these lines:
```apacheConf
        SetEnv force-proxy-request-1.0 1
        SetEnv proxy-nokeepalive 1
```

## Version 22.05.7

### 2022-06-12
The MySQL connector Java library has been updated again:
```bash
sed -re 's|(driverClassName=).*|\1"software.aws.rds.jdbc.mysql.Driver"|' /etc/tomcat9/Catalina/localhost/goobi.xml -i
```

## Previous Releases

### 2022-05-05
The MySQL connector Java library has been updated:
```bash
sed -re 's|(driverClassName=).*|\1"com.mysql.cj.jdbc.Driver"|' /etc/tomcat9/Catalina/localhost/goobi.xml -i
```

### 2022-05-04
The delivery plugin for Leiden University Library has been renamed. Instead of `plugin_intranda_step_file-delivery.jar` the file is now called `plugin_intranda_step_leiden_file_delivery.jar` and is downloadable from GitHub: https://github.com/intranda/goobi-plugin-step-leiden-file-delivery


### 2022-05-03
The rulesets must be adapted for the use of image coordinates. The following metadata elements must be created:
```xml
  <MetadataType>
    <Name>_COORDS</Name>
    <language name="de">Koordinaten</language>
    <language name="en">Coordinates</language>
  </MetadataType>
  <MetadataType>
    <Name>_SHAPE</Name>
    <language name="de">Form</language>
    <language name="en">Shape</language>
  </MetadataType>
```
This structural element must be created:
```xml
  <DocStrctType>
    <Name>area</Name>
    <language name="de">Region</language>
    <language name="en">Area</language>
    <metadata num="1o">_urn</metadata>
    <metadata num="1o">_COORDS</metadata>
    <metadata num="1o">_SHAPE</metadata>
    <metadata num="1m">physPageNumber</metadata>
    <metadata num="1m">logicalPageNumber</metadata>
  </DocStrctType>
```

And finally, this element must still be allowed within `page`:
```diff
  <DocStrctType>
	  <Name>page</Name>
	  <language name="de">Seite</language>
	  <language name="en">Page</language>
+	  <allowedchildtype>area</allowedchildtype>
	  <metadata num="1m">logicalPageNumber</metadata>
	  <metadata num="*">_ucc_id</metadata>
	  <metadata num="1m">physPageNumber</metadata>
	  <metadata num="1o">_urn</metadata>
  </DocStrctType>
```

Also the Metadata `_dateDigitization` might be missing in the rulesets for some document types. To automate all changes:

```bash
for R in /opt/digiverso/goobi/rulesets/*.xml; do

xmlstarlet sel -t -v 'boolean(Preferences/MetadataType/Name="_COORDS")' -n $R | bash ||
xmlstarlet ed --inplace \
 -a 'Preferences/MetadataType[last()]' -t elem -n MetadataType \
 --var pos '$prev' \
 -s '$pos' -t elem -n Name -v _COORDS \
 -s '$pos' -t elem -n language -v Koordinaten \
 -i '$prev' -t attr -n name -v de \
 -s '$pos' -t elem -n language -v Coordinates \
 -i '$prev' -t attr -n name -v en \
 $R

xmlstarlet sel -t -v 'boolean(Preferences/MetadataType/Name="_SHAPE")' -n $R | bash ||
xmlstarlet ed --inplace \
 -a 'Preferences/MetadataType[last()]' -t elem -n MetadataType \
 --var pos '$prev' \
 -s '$pos' -t elem -n Name -v _SHAPE \
 -s '$pos' -t elem -n language -v Form \
 -i '$prev' -t attr -n name -v de \
 -s '$pos' -t elem -n language -v Shape \
 -i '$prev' -t attr -n name -v en \
 $R

xmlstarlet sel -t -v 'boolean(Preferences/DocStrctType/Name="area")' -n $R | bash ||
xmlstarlet ed --inplace \
 -a 'Preferences/DocStrctType[last()]' -t elem -n DocStrctType \
 --var pos '$prev' \
 -s '$pos' -t elem -n Name -v area \
 -s '$pos' -t elem -n language -v Region \
 -s '$prev' -t attr -n name -v de \
 -s '$pos' -t elem -n language -v Area \
 -s '$prev' -t attr -n name -v en \
 -s '$pos' -t elem -n metadata -v _urn \
 -s '$prev' -t attr -n num -v 1o \
 -s '$pos' -t elem -n metadata -v _COORDS \
 -s '$prev' -t attr -n num -v 1o \
 -s '$pos' -t elem -n metadata -v _SHAPE \
 -s '$prev' -t attr -n num -v 1o \
 -s '$pos' -t elem -n metadata -v physPageNumber \
 -s '$prev' -t attr -n num -v 1m \
 -s '$pos' -t elem -n metadata -v logicalPageNumber \
 -s '$prev' -t attr -n num -v 1m \
 $R

xmlstarlet sel -t -v 'boolean(Preferences/DocStrctType[Name="page"]/allowedchildtype="area")' -n $R | bash ||
xmlstarlet ed --inplace \
 -a 'Preferences/DocStrctType[Name="page"]/language[last()]' -t elem -n allowedchildtype -v area \
 $R


xmlstarlet ed --inplace \
 -s '//DocStrctType[@topStruct="true"][not(metadata="_dateDigitization")]' -t elem -n metadata -v _dateDigitization \
 -i '$prev' -t attr -n num -v 1o \
 $R

done
```


### 2022-05-02
For the archive management plugin (if installed), an additional xq file must be available in the right place. This can be downloaded like this:

```bash
sudo -u tomcat wget https://raw.githubusercontent.com/intranda/goobi-plugin-administration-archive-management/master/plugin/src/main/resources/findDb.xq -O /opt/digiverso/basex/webapp/findDb.xq
```


### 2022-04-19
Line breaks in the configuration file `goobi_projects.xml` can affect the process title generation when creating new processes. The XML file can be reformatted this way (formatting is lost, especially of multiline comments):

```bash
TMPFILE=$(mktemp)
CONFIGFILE=/opt/digiverso/goobi/config/goobi_projects.xml
sed -zre 's|\s+| |g' "${CONFIGFILE}" |  python3 -c 'import sys; from xml.dom.minidom import parseString; s=sys.stdin.read(); print(parseString(s).toprettyxml())' | awk NF | sed -re 's/ $//' | xmlstarlet fo -e UTF-8 -s 4 > ${TMPFILE}
cat ${TMPFILE} > "${CONFIGFILE}"
rm ${TMPFILE}
```


### 2022-03-21
The syntax for the configuration file of the editor for configuration files has changed and should be re-installed on the system and adapted for this purpose. The current version of a sample configuration for the file `plugin_intranda_administration_config_file_editor.xml` can be found [here](https://github.com/intranda/goobi-plugin-administration-config-file-editor/blob/master/plugin/plugin_intranda_administration_config_file_editor.xml).


### 2022-02-25

#### goobi-plugin-import-excel: config changes:

The old version:

```xml
<!-- prefix path to the image folder. Can be empty or missing if the import doesn't contain images or if the excel field contains absolute path  -->
<imageFolderPath>/opt/digiverso/images/</imageFolderPath>
<!-- define which column contains the image folder name. Can be combined with <imageFolderPath> prefix or an absolute path.
If the field is missing, empty or does not contain an existing directory, no images will be imported -->
<imageFolderHeaderName>images</imageFolderHeaderName>

<!-- defines, if images are moved from the source folder to the destination (true) or copied (false) -->
<moveImages>true</moveImages>
```

Needs to be replaced with:

```xml
<importImages failOnMissingImageFiles="true">
    <!-- prefix path to the image folder. Can be empty or missing if the import doesn't contain images or if the excel field contains absolute path  -->
    <imageFolderPath>/opt/digiverso/images/</imageFolderPath>
    <!-- define which column contains the image folder name. Can be combined with <imageFolderPath> prefix or an absolute path.
    If the field is missing, empty or does not contain an existing directory, no images will be imported -->
    <imageFolderHeaderName>images</imageFolderHeaderName>
    <!-- Image handling strategy. Valid values are "move", "copy" or "ignore".  -->
    <imageHandlingStrategy>move</imageHandlingStrategy>
</importImages>
```

Script for this change:

```bash
file=/opt/digiverso/goobi/config/plugin_intranda_import_excel.xml

XSL=$(cat << "EOF"
<?xml version="1.0" ?>
<xsl:stylesheet version="1.0" encoding="UTF-8" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
    <xsl:output encoding="UTF-8" version="1.0" indent="yes"/>

    <xsl:template match="config">
        <xsl:copy>
            <xsl:apply-templates select="comment() | @* | *[not(self::steps|self::propertyName|self::propertyValue)]" />
            <importImages failOnMissingImageFiles="true">
                <xsl:copy-of select="imageFolderPath|imageFolderHeaderName"/>
                <imageHandlingStrategy>
                    <xsl:if test="moveImages = 'true'">move</xsl:if>
                    <xsl:if test="moveImages != 'true'">copy</xsl:if>
                    <xsl:if test="not(moveImages)">copy</xsl:if>
                </imageHandlingStrategy>
            </importImages>
        </xsl:copy>
    </xsl:template>

    <xsl:template match="config/imageFolderPath|config/imageFolderHeaderName|config/moveImages"/>

    <!-- IdentityTransform -->
    <xsl:template match="/ | @* | node()">
        <xsl:copy>
            <xsl:apply-templates select="@* | node()" />
        </xsl:copy>
    </xsl:template>

</xsl:stylesheet>
EOF
)

xmlstarlet tr <(echo "$XSL") $file | xmlstarlet fo -s 4 > ${file}.tmp
mv ${file}.tmp ${file}
```


### 2022-02-16

#### Database and Tomcat requirements
Goobi workflow now requires Tomcat 9 and MariaDB >= 10.1

#### Metadata editor: File manipulation now off by default
If you are missing "Page order" in "Pagination":
```bash
echo MetsEditorDisplayFileManipulation=true >> /opt/digiverso/goobi/config/goobi_config.properties
```

#### Renaming of the Sword export plugin
* The repository name is unchanged: [goobi-plugin-export-sword](https://github.com/intranda/goobi-plugin-export-sword)
* The plugin jar file changed from `plugin_intranda_export_mycore.jar` to `plugin_intranda_export_sword.jar`.
* The plugin config changed accordingly:
  ```bash
  mv -i /opt/digiverso/goobi/config/{plugin_MycoreExportPlugin.xml,plugin_intranda_export_sword.xml}
  ```
* The plugin name changed from `plugin_intranda_mycore_export` to `intranda_export_sword`:
  ```bash
  mysql goobi -e 'update schritte set stepplugin="intranda_export_sword" where stepplugin="plugin_intranda_mycore_export"'
  ```

### 2022-02-09
Goobi workflow has supported WebSockets for some time. To do this, its support in the Apache web server must be included in the configuration:

```bash
## make sure rewrite is enabled
RewriteEngine On
## Enable WebSockets to check concurrent access
RewriteCond %{HTTP:Upgrade} websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
RewriteRule /?(.*) ws://localhost:8080/$1 [P,L]
```


{% hint style="info" %}
If the Tomcat is not listening on 8080, please adjust the port accordingly. However, you must always forward to the HTTP connector, **not to the AJP connector**;
{% endhint %}

Then activate the required module and restart the service:

```bash
a2enmod proxy_wstunnel
systemctl restart apache2
```

### 2022-02-09
The file `docket_metadata.xsl` must be exchanged:

```bash
curl https://raw.githubusercontent.com/intranda/goobi-workflow/master/Goobi/install/xslt/docket_metadata.xsl > /opt/digiverso/goobi/xslt/docket_metadata.xsl
```

### 2021-12-16
The statistics plugin now exports XLSX instead of XLS, therefore the template file was changed. `/opt/digiverso/goobi/plugins/statistics/statistics_template.xls` needs to be replaced with `https://github.com/intranda/goobi-plugin-statistics-intranda/releases/latest/download/statistics_template.xlsx`.


### 2021-12-13
The configuration for configurable delay plugin has been adapted to the same scheme as the other step plugins. For this, the configuration file `plugin_intranda_delay_configurable.xml` must be adapted as follows as an example:

```diff
-           <delayInDays>3</delayInDays>
+           <!--
+               order of configuration is:
+                 1.) project name and step name matches
+                 2.) step name matches and project is *
+                 3.) project name matches and step name is *
+                 4.) project name and step name are *
+       	-->
+           
+           <config>
+               <!-- which projects to use for (can be more then one, otherwise use *) -->
+               <project>*</project>
+               <step>*</step>
+               
+               <!-- Delay in days -->
+               <delayInDays>3</delayInDays>
+           </config>
```


### 2021-11-25
The configuration for the generateIdentifier plugin needs to have a `<type>` added to `plugin_intranda_step_generateIdentifier.xml` because the default has changed from `random` to `uuid`:

```diff
         <!-- into which field shall the new identifier be written -->
         <field>DigitalID</field>
+        <!-- which type of identifier shall be created? Possible values are random, timestamp, uuid -->
+        <type>random</type>
         <!-- how long shall the new identifier be -->
         <length>9</length>
```


### 2021-11-11
The compiled file for the plugin `plugin_intranda_step_move_folder_to_master` has been renamed as the plugin is called. For the installation, this means that the previously installed plug-in file is now replaced by a new one:

```diff
-       /opt/digiverso/goobi/plugins/step/plugin_intranda_step_move-folder.jar
+       /opt/digiverso/goobi/plugins/step/plugin_intranda_step_move_folder_to_master.jar
```


### 2021-11-06
For the Catalogue Poller plugin there was a similar change in the configuration file `plugin_intranda_administration_catalogue_poller.xml` as for the Catalogue Request plugin. Here the field name is now also configurable:

```diff
-       <catalogueIdentifier>$(meta.CatalogIDDigital)</catalogueIdentifier>
+       <catalogueField fieldName="12" fieldValue="$(meta.CatalogIDDigital)" />
```


### 2021-11-06
For the Catalogue-Request-Plugin there was a change in the configuration file `plugin_intranda_step_catalogue_request.xml` so that parameters were merged. Here, of course, attention must be paid to the respective configuration of the installation:

```diff
-       <catalogueField>12</catalogueField>
-       <catalogueIdentifier>$(meta.CatalogIDDigital)</catalogueIdentifier>
+       <catalogueField fieldName="12" fieldValue="$(meta.CatalogIDDigital)" />
```


### 2021-10-12
If database tables still use the Row Format Compact, this should be changed to Dynamic. For example, like this (adjust DB name if necessary):
```bash
mysql -NBse 'show table status in goobi where Row_format="compact"' | cut -f1 | xargs -I€ mysql goobi -NBse 'alter table € row_format=Dynamic'
```


### 2021-09-28
Within the configuration for the xmp-header plugin, the definition of the folders is different. For this, the following change must be made in the configuration file `plugin_intranda_step_xmp_header.xml`:

```diff
-       <!-- define if the images in master folder are used -->
-       <useDerivateFolder>true</useDerivateFolder>
-       <!-- define if the images in master folder are used -->
-       <useMasterFolder>false</useMasterFolder>
+        <!-- which images to use , possible values are master|main|jpeg|source|... -->
+        <folder>master</folder>
+        <folder>media</folder>
```


### 2021-09-23
Within the configuration file `goobi_opac.xml` a possible typing error has to be corrected. Instead of `MultivolumeWork` it should read `MultiVolumeWork`:

```diff
- rulesetType="MultivolumeWork"
+ rulesetType="MultiVolumeWork"
```


### 2021-09-09
The keystore information is no longer stored from the Goobi workflow user interface but via a configuration within the configuration file `goobi_config.properties`. The keystore can now be defined there as follows:

```text
truststore = /path/to/file
truststore_password = password
```


### 2021-09-03
There have been changes to SQL queries in Goobi workflow that make the following changes necessary:

```sql
CREATE INDEX institution ON projekte (institution_id);
CREATE INDEX processid_x_title_x_status ON schritte(ProzesseID, Titel, Bearbeitungsstatus);
CREATE INDEX processid_x_title_x_status_x_user ON schritte(ProzesseID, Titel, Bearbeitungsstatus, BearbeitungsBenutzerID);
CREATE INDEX metadata_name ON metadata(name);
alter table metadata add FULLTEXT(value);
alter table processlog add FULLTEXT(content);
ALTER TABLE werkstueckeeigenschaften MODIFY titel VARCHAR(190);
CREATE INDEX title ON werkstueckeeigenschaften(Titel);
CREATE FULLTEXT INDEX value ON werkstueckeeigenschaften(WERT);
ALTER TABLE vorlageneigenschaften MODIFY titel VARCHAR(190);
CREATE INDEX title ON vorlageneigenschaften(Titel);
CREATE FULLTEXT INDEX value ON vorlageneigenschaften(WERT);
alter table schritte ROW_FORMAT=DYNAMIC;
alter table prozesse ROW_FORMAT=DYNAMIC;
alter table projekte ROW_FORMAT=DYNAMIC;
```

Additionally, it is a good idea to delete some stale data. This data is now deleted automatically by Goobi, but there might be old data in the database:

```sql
delete from schritte where ProzesseID not in (select ProzesseID from prozesse);
delete from processlog where processid not in (select ProzesseID from prozesse);
delete from metadata where processid not in (select ProzesseID from prozesse);
delete from history where processid not in (select ProzesseID from prozesse);
delete from prozesseeigenschaften where prozesseid not in (select ProzesseID from prozesse);
```


### 2021-09-01
Java 11 is needed from now on to run Goobi workflow. The package `openjdk-11-jre-headless` is a good option for Ubuntu users.

If there are runnable Jars included in your workflow (e.g. urn-generator.jar), please update these too.


### 2021-07-16
The import plugin ~~`plugin_intranda_import_mab_file`~~ has been renamed to `plugin_intranda_import_sisis_sunrise_file`. Accordingly, the following files must be replaced with new versions and the configuration file renamed accordingly:

```diff
-  plugin_intranda_import_mab_file.jar
+  plugin_intranda_import_sisis_sunrise_file.jar

-  plugin_intranda_import_mab_file.xml
+  plugin_intranda_import_sisis_sunrise_file.xml
```


### 2021-07-12
In the configuration file `plugin_intranda_step_changeWorkflow.xml` the name of the property to be checked must be adapted because the variable-replacer is used here. The values used must be checked accordingly and adapted according to this example:

```diff
-  <propertyName>TemplateID</propertyName>
+  <propertyName>{process.TemplateID}</propertyName>
```


### 2021-06-23
For better performance in database queries \(e.g. when calling the process list\) execute the following statements:

```sql
mysql goobi
#
ALTER TABLE schritte DROP INDEX Titel;
ALTER TABLE schritte DROP INDEX processid_x_title;
ALTER TABLE schritte DROP INDEX id_x_title;
ALTER TABLE schritte DROP INDEX processid_x_title_x_user;
ALTER TABLE prozesse DROP INDEX Titel;
ALTER TABLE schritte MODIFY titel VARCHAR(190);
ALTER TABLE prozesse MODIFY titel VARCHAR(190);
ALTER TABLE projekte MODIFY titel VARCHAR(190);
CREATE INDEX title ON schritte(Titel);
CREATE INDEX processid_x_title ON schritte(ProzesseID, Titel);
CREATE INDEX id_x_title ON schritte(SchritteID, Titel);
CREATE INDEX processid_x_title_x_user ON schritte(SchritteID, Titel, BearbeitungsBenutzerID);
CREATE INDEX title ON prozesse(Titel);
CREATE INDEX status_x_title ON schritte(Bearbeitungsstatus, Titel);
ALTER TABLE metadata MODIFY name VARCHAR(190);
```

Creating the indexes and changing the database tables can take several minutes for large datasets, and is therefore performed manually and not automatically during the update.


### 2021-03-24
For the dockets, the expression for displaying the creation date for the process has been changed to homogenise it. Instead of the previous expression `goobi:time`, it has to be changed to the expression `goobi:creationDate` within the xsl files. This usually affects the docket files under the following paths:

```bash
/opt/digiverso/goobi/xslt/docket.xsl
/opt/digiverso/goobi/xslt/docket_english.xsl
/opt/digiverso/goobi/xslt/docket_multipage.xsl
```

Here is a detailed example of the change:

```diff
<fo:table-row>
    <fo:table-cell>
        <fo:block>
            Creation date:
        </fo:block>
    </fo:table-cell>
    <fo:table-cell>
        <fo:block>
-           <xsl:value-of select="goobi:time"/>
+            <xsl:value-of select="goobi:creationDate"/>
        </fo:block>
    </fo:table-cell>
</fo:table-row>
```


### 2021-01-09
The plugin ~~`intranda_dashboard_example`~~ has been renamed to `intranda_dashboard_extended`. On the system, the previous files must therefore be replaced with the files with the new names during the update:

```diff
- plugin_intranda_dashboard_example.jar
- plugin_intranda_dashboard_example-GUI.jar
+ plugin_intranda_dashboard_extended.jar
+ plugin_intranda_dashboard_extended-GUI.jar
```

The configuration file `plugin_intranda_dashboard_extended.xml` already present on the systems can thus continue to exist unchanged.

For future updates and installations, please note that the Git repository and the Maven artefact from Jenkins have also been adapted to the new name `plugin_intranda_dashboard_extended`.


### 2021-01-03
The plugin ~~`intranda_statistics_sudan_activity_by_user`~~ has been renamed to `intranda_statistics_sudan_memory_activity_by_user`. On the system, the previous files must therefore be replaced with the files with new names during the update:

```diff
- plugin_intranda_statistics_sudan.jar
- plugin_intranda_statistics_sudan-GUI.jar
+ plugin_intranda_statistics_sudan_memory.jar
+ plugin_intranda_statistics_sudan_memory-GUI.jar
```


### 2020-09-17
In the ImageQA plugin, the configuration of the rotation and deletion commands has changed. These have to be adapted.

This is the old configuration:

```markup
<deletionCommand>/opt/digiverso/goobi/scripts/deleteImage.sh IMAGE_FOLDER IMAGE_FILE</deletionCommand>
<rotationCommands>
    <left>/usr/bin/mogrify -rotate -90 IMAGE_FILE</left>
    <right>/usr/bin/mogrify -rotate 90 IMAGE_FILE</right>
</rotationCommands>
```

The new one looks like this:

```markup
<deletion command="/opt/digiverso/goobi/scripts/deleteImage.sh|IMAGE_FOLDER|IMAGE_FILE"/>
<rotationCommands>
    <left command="/usr/bin/mogrify|-rotate|-90|IMAGE_FILE" />
    <right command="/usr/bin/mogrify|-rotate|90|IMAGE_FILE" />
</rotationCommands>
```

### 2020-08-09

#### Renaming of the Excel import plugin
Das generische Excel-Import-Plugin wurde von ~~`plugin_intranda_import_generic_excel.jar`~~ zu `plugin_intranda_import_excel.jar` umbenannt. Dies hat ebenso einen Einfluß auf die Konfigurationsdatei. Diese heisst statt ~~`plugin_intranda_import_excel_read_headerdata.xml`~~ von nun an `plugin_intranda_import_excel.xml`.

The generic Excel import plugin has been renamed from ~~`plugin_intranda_import_generic_excel.jar`~~ to `plugin_intranda_import_excel.jar` This also has an effect on the configuration file. Instead of ~~`plugin_intranda_import_excel_read_headerdata.xml`~~ this file is now called `plugin_intranda_import_excel.xml`.

### 2020-07-31

#### New default naming scheme for the master folder
The default name of the master folder has changed from `master_{processtitle}_media` to `{processtitle}_master` Optionally you can now adjust the folder structure in all operations or stay with the previous scheme - a configuration option is added for this:

```text
echo 'process.folder.images.master=master_{processtitle}_media' >> /opt/digiverso/goobi/config/goobi_config.properties
```

{% hint style="info" %}
If other folder names have been used, either adjust the above setting as necessary or perform all operations and steps.
{% endhint %}

For example, if the `orig_{processtitle}_tif` and `{processtitle}_tif` folders were previously used for master and derivatives, i.e. the setting

```bash
DIRECTORY_SUFFIX=tif
DIRECTORY_PREFIX=orig
```

Then this must now be replaced by the following in `/opt/digiverso/goobi/config/goobi_config.properties`

```bash
process.folder.images.master=orig_{processtitle}_tif
process.folder.images.main={processtitle}_tif
```

If the option `MetsEditorDefaultSuffix=jpeg` was previously used, this must now be replaced as follows:

```bash
process.folder.images.fallback={processtitle}_jpeg
```

### 2020-07-29

#### intranda\_step\_changeWorkflow
In this plugin it is now possible to define several changes for each depending on different process properties. Therefore a new XML element was introduced, which has to be added to the config file, see also: [https://docs.goobi.io/goobi-workflow-plugins-en/step/intranda\_step\_changeworkflow](https://docs.goobi.io/goobi-workflow-plugins-en/step/intranda_step_changeworkflow)

With this file this can be automated:

{% code title="/tmp/addChangeElement.xsl" %}
```text
<?xml version="1.0" ?>
<xsl:stylesheet version="1.0" encoding="UTF-8" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
    <xsl:output encoding="UTF-8" version="1.0" indent="yes"/>

    <xsl:template match="config">
        <xsl:copy>
            <xsl:apply-templates select="comment() | @* | *[not(self::steps|self::propertyName|self::propertyValue)]" />
            <change><xsl:copy-of select="steps|propertyName|propertyValue"/></change>
        </xsl:copy>
    </xsl:template>

    <!-- IdentityTransform -->
    <xsl:template match="/ | @* | node()">
        <xsl:copy>
            <xsl:apply-templates select="@* | node()" />
        </xsl:copy>
    </xsl:template>

</xsl:stylesheet>
```
{% endcode %}

Execute:

```text
file=/opt/digiverso/goobi/config/plugin_intranda_step_changeWorkflow.xml; xmlstarlet tr /tmp/addChangeElement.xsl ${file} | xmlstarlet fo -e utf-8 -s 4 >${file}.tmp; mv ${file}.tmp ${file}
```

### 2020-07-01

#### Escaping in configuration files
The configuration parser was changed so that the commas and backslashes no longer need to be escaped. All occurrences of `\,` must be replaced by `,` and `\\` by `\`. Instead `|` in xml-attributes are now escaped. The following files under `/opt/digiverso/goobi/config/` are affected:

* [ ] **plugin\_**\*.**xml**
* [ ] **goobi\_projects**.**xml**
* [ ] **plugin\_metadata\_easydb**.**xml**
* [ ] **goobi\_opac**.**xml**
* [ ] **goobi\_exportXml**.**xml**
* [ ] **goobi\_metadataDisplayRules**.**xml**
* [ ] **goobi\_mail**.**xml**
* [ ] **goobi\_rest**.**xml**
* [ ] **goobi\_webapi**.**xml**
* [ ] **goobi\_hotfolder.xml**
* [ ] **goobi\_processProperties.xml**

Find affected files \(backslashes\) - please adjust manually:

```bash
grep -F -l -e '\\' -e '\,' /opt/digiverso/goobi/config/*.xml
```

Find affected files \(pipe sign\):

```text
for i in /opt/digiverso/goobi/config/*.xml; do j=$(xmlstarlet sel -t -v '//@*[contains(.,"|")]' $i | grep -P '[^\\]\|'); test -n "$j" && echo -e "\n\n==> $i <==\n$j"; done
```

Probably only the `goobi_projects.xml` is affected here, which can be adapted as follows:

```text
file=/opt/digiverso/goobi/config/goobi_projects.xml; xmlstarlet sel -t -v '//@*[contains(.,"|")]' -n "$file" | sort -u | perl -e 'print sort { length $b <=> length $a } <>' | while read i; do sed -i -e "s+${i}+${i//|/\\\\|}+g" "$file"; done
```

For the plugin `goobi-plugin-step-xmpheader` changes how the parameters for the `exiftool` are specified:

{% code title="plugin\_write-xmp.xml" %}
```diff
-        <parameter>-overwrite_original, -q, -q, -m, {PARAM}, {FILE}</parameter>
+        <parameter>-overwrite_original</parameter>
+        <parameter>-q</parameter>
+        <parameter>-q</parameter>
+        <parameter>-m</parameter>
+        <parameter>{PARAM}</parameter>
+        <parameter>{FILE}</parameter>
```
{% endcode %}

#### ImageQA-Plugin
The folder name has changed:

{% code title="plugin\_intranda\_step\_imageQA.xml" %}
```diff
-        <useOrigFolder>true</useOrigFolder>
+        <!-- which images to use , possible values are master|main|jpeg|source|... -->
+        <foldername>master</foldername>
```
{% endcode %}


### 2020-05-08
If the plugin is used for `Generic Excel import`, the mapping of the metadata must be adjusted in the configuration file. The attribute `name` was renamed to `property`:

{% code title="plugin\_intranda\_import\_excel\_read\_headerdata.xml" %}
```markup
<!-- Old -->
<metadata headerName="XXX" docType="child" name="YYY"/>
<!-- New -->
<metadata headerName="XXX" docType="child" property="YYY"/>
```
{% endcode %}


### 2020-03-25
If the `LayoutWizzard` plugin is installed, the section from `<contentBorder>` to `</preview>` in its configuration file must be replaced by the following section

{% code title="plugin\_intranda\_step\_LayoutWizzard.xml" %}
```markup
<!-- Config for appearance of single/large image -->
<singleImage>
    <cropFrame>
        <linewidth>2</linewidth>
        <linecolor>#00fa9a</linecolor>
        <fillcolor>#ffffff</fillcolor>
        <clickradius>20</clickradius>
        <fillcolor>#ffffff</fillcolor>
    </cropFrame>
    <spineMarker>
        <linewidth>2</linewidth>
        <linecolor>#ff0000</linecolor>
        <fillcolor>#ffffff</fillcolor>
        <clickradius>20</clickradius>
    </spineMarker>
</singleImage>

<!-- Config for appearance of images in preview mode -->
<preview>
    <cropFrame>
        <linewidth>2</linewidth>
        <linecolor>#368EE0</linecolor>
        <fillcolor>#f1f2f3</fillcolor>
        <clickradius>20</clickradius>
        <fillcolor>#f1f2f3</fillcolor>
    </cropFrame>
    <spineMarker>
        <linewidth>2</linewidth>
        <linecolor>#ff0000</linecolor>
        <fillcolor>#f1f2f3</fillcolor>
        <clickradius>10</clickradius>
    </spineMarker>
</preview>
```
{% endcode %}

### 2020-03-05

#### Dockets
The style of the dockets was adapted and support for Hebrew characters was added. If the routing slips have not been individually adapted, the files can be replaced 1:1. For this purpose, the generation should be tried out in the user interface before. The following steps are more defensively formulated to prevent accidental automatic overwriting:

```bash
TMPDIR=$(mktemp -d)
cd $TMPDIR
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/config.xml
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/docket.xsl
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/docket_english.xsl
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/docket_metadata.xsl
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/docket_multipage.xsl
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/font_OpenSans-Regular.ttf
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/font_OpenSans-Semibold.ttf
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/font_OpenSansHebrew-Bold.ttf
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/font_OpenSansHebrew-Regular.ttf
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/logo.png
wget -q https://raw.githubusercontent.com/intranda/goobi/master/Goobi/install/xslt/placeholder.png
cp -i * /opt/digiverso/goobi/xslt/ # do not overwrite things
```

The previous standard XSLT files have the following MD5 hash:

```bash
28157e2d48053d4700034372e91a3210  docket_english.xsl
47a9846db78ae8df9b517ee8ef1a2216  docket_multipage.xsl
b55280e1d70b66d66d5a1f801cf3db14  docket.xsl
```

After completion of the work, the generation of the dockets should be checked again.


#### LDAP-Konfiguration
{% hint style="info" %}
Before removing the LDAP configuration from the Goobi workflow config file, it is important to start with the new `goobi.war` so that the migration to the database takes place.
{% endhint %}

The LDAP configuration was migrated from the configuration file to the database. After the update, the corresponding block can be removed from the `goobi_config.properties` file.


### 2020-02-12
For the ActiveMQ interface the available resources must be specified:

{% code title="goobi\_activemq.xml" %}
```markup
<beans>
    <broker>
        <systemUsage>
            <systemUsage>
                <memoryUsage>
                    <memoryUsage limit="64 mb"/>
                </memoryUsage>
                <storeUsage>
                    <storeUsage limit="512 mb"/>
                </storeUsage>
                <tempUsage>
                    <tempUsage limit="128 mb"/>
                </tempUsage>
            </systemUsage>
        </systemUsage>
    </broker>
</beans>
```
{% endcode %}


### 2020-01-30
{% hint style="info" %}
Before these points are processed, Goobi workflow must be started once with the new `goobi.war` to update the database schema.
{% endhint %}

Since you can only make other users super-administrators as super-administrators, an account should be set manually in the database when updating. Subsequently, further accounts can be adjusted by means of a checkbox in the user administration.

The following SQL statements will help here:

```bash
mysql goobi -Nbse'SELECT benutzerid, login FROM benutzer WHERE login REGEXP "admin|intranda"'
# mysql goobi -e 'UPDATE benutzer SET superadmin = true WHERE benutzerid =XXXX'
```


### 2020-01-18
Goobi workflow now uses `log4j2` and comes with its own configuration file. You will therefore need to remove the overwriting entries from `/etc/default/tomcat8`:

```bash
patch /etc/default/tomcat8 <<"EOF"
@@ -26,2 +25,0 @@
-JAVA_OPTS="${JAVA_OPTS} -Dlog4j.configuration=file:///opt/digiverso/config/log4j.properties"
-JAVA_OPTS="${JAVA_OPTS} -Dlog4j.configurationFile=/opt/digiverso/config/log4j2.xml"
EOF
```
